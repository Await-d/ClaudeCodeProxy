name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20.x'

jobs:
  # åç«¯å•å…ƒæµ‹è¯•
  test-backend-unit:
    runs-on: ubuntu-latest
    name: Backend Unit Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore ClaudeCodeProxy/ClaudeCodeProxy.sln
    
    - name: Build solution
      run: dotnet build ClaudeCodeProxy/ClaudeCodeProxy.sln --no-restore --configuration Release
    
    - name: Run unit tests
      run: |
        dotnet test ClaudeCodeProxy/tests/ClaudeCodeProxy.UnitTests \
          --no-build \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./test-results/unit \
          --logger "trx;LogFileName=unit-test-results.trx" \
          --logger "console;verbosity=detailed"
    
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-unit-test-results
        path: ./test-results/unit/
        retention-days: 30

  # åç«¯é›†æˆæµ‹è¯•
  test-backend-integration:
    runs-on: ubuntu-latest
    name: Backend Integration Tests
    needs: test-backend-unit
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore ClaudeCodeProxy/ClaudeCodeProxy.sln
    
    - name: Build solution
      run: dotnet build ClaudeCodeProxy/ClaudeCodeProxy.sln --no-restore --configuration Release
    
    - name: Run integration tests
      run: |
        dotnet test ClaudeCodeProxy/tests/ClaudeCodeProxy.IntegrationTests \
          --no-build \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./test-results/integration \
          --logger "trx;LogFileName=integration-test-results.trx" \
          --logger "console;verbosity=detailed"
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-integration-test-results
        path: ./test-results/integration/
        retention-days: 30

  # å‰ç«¯æµ‹è¯•
  test-frontend:
    runs-on: ubuntu-latest
    name: Frontend Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ClaudeCodeProxy/web/package-lock.json
    
    - name: Install dependencies
      working-directory: ClaudeCodeProxy/web
      run: npm ci
    
    - name: Run linter
      working-directory: ClaudeCodeProxy/web
      run: npm run lint
    
    - name: Run type checking
      working-directory: ClaudeCodeProxy/web
      run: npx tsc --noEmit
    
    - name: Run unit tests
      working-directory: ClaudeCodeProxy/web
      run: npm run test:coverage
    
    - name: Upload frontend test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-test-results
        path: ClaudeCodeProxy/web/coverage/
        retention-days: 30

  # ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
  coverage-report:
    runs-on: ubuntu-latest
    name: Generate Coverage Report
    needs: [test-backend-unit, test-backend-integration, test-frontend]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
    
    - name: Setup .NET for ReportGenerator
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool
    
    - name: Generate backend coverage report
      run: |
        reportgenerator \
          -reports:"backend-*/coverage.cobertura.xml" \
          -targetdir:"coverage-report/backend" \
          -reporttypes:"Html;JsonSummary;Badges;TextSummary" \
          -title:"ClaudeCodeProxy Backend Coverage"
    
    - name: Merge all coverage reports
      run: |
        mkdir -p coverage-report/combined
        
        # ç”Ÿæˆåˆå¹¶æŠ¥å‘Š
        reportgenerator \
          -reports:"backend-*/coverage.cobertura.xml;frontend-test-results/lcov.info" \
          -targetdir:"coverage-report/combined" \
          -reporttypes:"Html;JsonSummary;Badges;TextSummary" \
          -title:"ClaudeCodeProxy Full Coverage Report"
    
    - name: Extract coverage percentage
      id: coverage
      run: |
        if [ -f "coverage-report/combined/Summary.json" ]; then
          COVERAGE=$(cat coverage-report/combined/Summary.json | jq -r '.summary.linecoverage')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const body = `## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
          
          **æ€»è¦†ç›–ç‡**: ${coverage}%
          
          ${coverage >= 80 ? 'âœ…' : 'âŒ'} è¦†ç›–ç‡ç›®æ ‡: 80%
          
          è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [Coverage Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage-report/
        retention-days: 30
    
    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: backend-*/coverage.cobertura.xml,frontend-test-results/lcov.info
        fail_ci_if_error: false
        verbose: true

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ClaudeCodeProxy/ClaudeCodeProxy.sln
    
    - name: Run .NET security scan
      run: dotnet list ClaudeCodeProxy/ClaudeCodeProxy.sln package --vulnerable --include-transitive 2>&1 | tee security-scan.txt
    
    - name: Setup Node.js for npm audit
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Run npm security audit
      working-directory: ClaudeCodeProxy/web
      run: |
        npm audit --audit-level=moderate --json > npm-audit.json || true
        npm audit --audit-level=moderate || true
    
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          security-scan.txt
          ClaudeCodeProxy/web/npm-audit.json
        retention-days: 30

  # è´¨é‡é—¨ç¦
  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    needs: [test-backend-unit, test-backend-integration, test-frontend, coverage-report, security-scan]
    if: always()
    
    steps:
    - name: Download coverage report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
    
    - name: Check coverage threshold
      run: |
        if [ -f "combined/Summary.json" ]; then
          COVERAGE=$(cat combined/Summary.json | jq -r '.summary.linecoverage' | cut -d'%' -f1)
          echo "Current coverage: $COVERAGE%"
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold 80%"
            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets threshold"
          fi
        else
          echo "âŒ Coverage report not found"
          exit 1
        fi
    
    - name: Check test results
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•å¤±è´¥
        if [ "${{ needs.test-backend-unit.result }}" != "success" ]; then
          echo "âŒ Backend unit tests failed"
          exit 1
        fi
        
        if [ "${{ needs.test-backend-integration.result }}" != "success" ]; then
          echo "âŒ Backend integration tests failed"
          exit 1
        fi
        
        if [ "${{ needs.test-frontend.result }}" != "success" ]; then
          echo "âŒ Frontend tests failed"
          exit 1
        fi
        
        echo "âœ… All tests passed"
    
    - name: Quality gate summary
      run: |
        echo "## ğŸ¯ è´¨é‡é—¨ç¦æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åç«¯å•å…ƒæµ‹è¯•: ${{ needs.test-backend-unit.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åç«¯é›†æˆæµ‹è¯•: ${{ needs.test-backend-integration.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å‰ç«¯æµ‹è¯•: ${{ needs.test-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç è¦†ç›–ç‡: >= 80%" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œä»£ç å¯ä»¥éƒ¨ç½²ï¼" >> $GITHUB_STEP_SUMMARY

  # æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆä»…åœ¨mainåˆ†æ”¯è¿è¡Œï¼‰
  performance-benchmark:
    runs-on: ubuntu-latest
    name: Performance Benchmark
    if: github.ref == 'refs/heads/main'
    needs: quality-gate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Run performance benchmarks
      run: |
        if [ -d "ClaudeCodeProxy/tests/ClaudeCodeProxy.PerformanceTests" ]; then
          dotnet run --project ClaudeCodeProxy/tests/ClaudeCodeProxy.PerformanceTests --configuration Release
        else
          echo "Performance tests not found, skipping..."
        fi
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-benchmark-results
        path: BenchmarkDotNet.Artifacts/
        retention-days: 30